---
title: "Water Intake and Diabetes in US Adults: NHANES 2021-2023"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(readxl)
library(tableone)
library(knitr)
library(kableExtra)
library(patchwork)
library(ggpubr)
library(corrplot)
library(gtsummary)
```

# Data Preparation
```{r prep}
data <- read_excel("final_data.xlsx")

df <- data %>%
  # Filter out Race categories with 0 obser
  filter(!Race %in% c(6, 7)) %>%
  mutate(
    #Continuous variables as numeric
    Age = as.numeric(Age),
    BMI = as.numeric(BMI),
    Income_PIR = as.numeric(Income_PIR),
    Energy_kcal = as.numeric(Energy_kcal),
    Sugar_g = as.numeric(Sugar_g),
    Water_g = as.numeric(Water_g),
    HbA1c = as.numeric(HbA1c),
    
    #Categorical variables as factors
    Gender = factor(Gender, levels = c(0, 1), 
                   labels = c("Female", "Male")),
    
    # Only keep Race categories (1,2,3,4)
    Race = factor(Race, levels = c(1, 2, 3, 4),
                 labels = c("Mexican American", "Other Hispanic", 
                           "Non-Hispanic White", "Non-Hispanic Black")),
    
    Education = factor(Education, levels = c(1, 2, 3, 4, 5),
                      labels = c("< 9th grade", "9-11th grade", 
                                "High school/GED", "Some college", 
                                "College grad+")),
    
    Smoking = factor(Smoking, levels = c(0, 1),
                    labels = c("No", "Yes")),
    
    Diabetes = factor(Diabetes, levels = c(0, 1),
                     labels = c("No", "Yes")),

    #Create water quartiles
    Water_Q = cut(Water_g, 
                  breaks = quantile(Water_g, probs = seq(0, 1, 0.25)),
                  labels = c("Q1", "Q2", "Q3", "Q4"),
                  include.lowest = TRUE)
  )

#Set Q1 reference group
df$Water_Q <- relevel(df$Water_Q, ref = "Q1")

#Create numeric version for trend test
df$Water_Q_numeric <- as.numeric(df$Water_Q)
```

# Table 1: Baseline Characteristics by Diabetes Status
```{r table1}
tab1 <- CreateTableOne(
  vars = c("Age", "Gender", "Race", "Education", "BMI", "Income_PIR", 
           "Smoking", "Energy_kcal", "Sugar_g", "Water_g", "HbA1c"),
  strata = "Diabetes",
  data = df,
  factorVars = c("Gender", "Race", "Education", "Smoking"),
  test = FALSE
)

#Get table output (median/IQR for continuous)
tab1_print <- print(tab1, 
                   nonnormal = c("Age", "BMI", "Income_PIR", "Energy_kcal", 
                                "Sugar_g", "Water_g", "HbA1c"),
                   showAllLevels = TRUE,
                   printToggle = FALSE)

# Calculate p-values
# Continuous: Wilcoxon test
# Categorical: Chi-square test
p_vals <- c(
  wilcox.test(Age ~ Diabetes, data = df)$p.value,
  wilcox.test(BMI ~ Diabetes, data = df)$p.value,
  wilcox.test(Income_PIR ~ Diabetes, data = df)$p.value,
  wilcox.test(Energy_kcal ~ Diabetes, data = df)$p.value,
  wilcox.test(Sugar_g ~ Diabetes, data = df)$p.value,
  wilcox.test(Water_g ~ Diabetes, data = df)$p.value,
  wilcox.test(HbA1c ~ Diabetes, data = df)$p.value,
  chisq.test(table(df$Gender, df$Diabetes))$p.value,
  chisq.test(table(df$Race, df$Diabetes))$p.value,
  chisq.test(table(df$Education, df$Diabetes))$p.value,
  chisq.test(table(df$Smoking, df$Diabetes))$p.value
)

#Format p-values
format_p <- function(p) {
  if(is.na(p)) return("NA")
  if(p < 0.001) return("<0.001")
  return(sprintf("%.3f", p))
}

p_fmt <- sapply(p_vals, format_p)


tab1_df <- as.data.frame(tab1_print)
tab1_df$P <- ""
var_names <- c("Age", "BMI", "Income_PIR", "Energy_kcal", "Sugar_g", 
               "Water_g", "HbA1c", "Gender", "Race", "Education", "Smoking")
for(i in 1:length(var_names)) {
  rows <- grep(var_names[i], rownames(tab1_df))
  if(length(rows) > 0) tab1_df$P[rows[1]] <- p_fmt[i]
}

# Show
kable(tab1_df, caption = "Table 1: Baseline Characteristics by Diabetes Status") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  footnote(general = c("Continuous variables: Median (IQR), Wilcoxon rank-sum test",
                      "Categorical variables: n (%), Chi-square test"))

write.csv(tab1_df, "Table1.csv")
```

# Table 2: Baseline Characteristics by Water Quartiles
```{r table2}
tab2 <- CreateTableOne(
  vars = c("Age", "Gender", "Race", "Education", "BMI", "Income_PIR", 
           "Smoking", "Energy_kcal", "Sugar_g", "HbA1c", "Diabetes"),
  strata = "Water_Q",
  data = df,
  factorVars = c("Gender", "Race", "Education", "Smoking", "Diabetes"),
  test = FALSE
)

#output
tab2_print <- print(tab2,
                   nonnormal = c("Age", "BMI", "Income_PIR", "Energy_kcal", 
                                "Sugar_g", "HbA1c"),
                   showAllLevels = TRUE,
                   printToggle = FALSE)

# Calculate p-values
# Continuous: Kruskal-Wallis test (>2 groups)
# Categorical: Chi-square test
p_vals2 <- c(
  kruskal.test(Age ~ Water_Q, data = df)$p.value,
  kruskal.test(BMI ~ Water_Q, data = df)$p.value,
  kruskal.test(Income_PIR ~ Water_Q, data = df)$p.value,
  kruskal.test(Energy_kcal ~ Water_Q, data = df)$p.value,
  kruskal.test(Sugar_g ~ Water_Q, data = df)$p.value,
  kruskal.test(HbA1c ~ Water_Q, data = df)$p.value,
  chisq.test(table(df$Gender, df$Water_Q))$p.value,
  chisq.test(table(df$Race, df$Water_Q))$p.value,
  chisq.test(table(df$Education, df$Water_Q))$p.value,
  chisq.test(table(df$Smoking, df$Water_Q))$p.value,
  chisq.test(table(df$Diabetes, df$Water_Q))$p.value
)

#Format p
p_fmt2 <- sapply(p_vals2, format_p)

# Add to table
tab2_df <- as.data.frame(tab2_print)
tab2_df$P <- ""
var_names2 <- c("Age", "BMI", "Income_PIR", "Energy_kcal", "Sugar_g", "HbA1c",
                "Gender", "Race", "Education", "Smoking", "Diabetes")
for(i in 1:length(var_names2)) {
  rows <- grep(var_names2[i], rownames(tab2_df))
  if(length(rows) > 0) tab2_df$P[rows[1]] <- p_fmt2[i]
}

#Show
kable(tab2_df, caption = "Table 2: Baseline Characteristics by Water Quartiles") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  footnote(general = c("Continuous variables: Median (IQR), Kruskal-Wallis test",
                      "Categorical variables: n (%), Chi-square test"))

write.csv(tab2_df, "Table2.csv")
```

# Logistic Regression: Diabetes Risk by Water Quartiles
```{r logistic}
#3 models with water quartiles
m1 <- glm(Diabetes ~ Water_Q, data = df, family = binomial)

m2 <- glm(Diabetes ~ Water_Q + Age + Gender + Race + Education + Income_PIR, 
          data = df, family = binomial)

m3 <- glm(Diabetes ~ Water_Q + Age + Gender + Race + Education + Income_PIR + 
            BMI + Smoking + Energy_kcal + Sugar_g, 
          data = df, family = binomial)

# Trend test models
m1_trend <- glm(Diabetes ~ Water_Q_numeric, data = df, family = binomial)

m2_trend <- glm(Diabetes ~ Water_Q_numeric + Age + Gender + Race + Education + Income_PIR, 
                data = df, family = binomial)

m3_trend <- glm(Diabetes ~ Water_Q_numeric + Age + Gender + Race + Education + Income_PIR + 
                  BMI + Smoking + Energy_kcal + Sugar_g, 
                data = df, family = binomial)

# Extract OR
extract_OR <- function(model, model_name, trend_model) {
  # Get all coefficients
  coef_table <- summary(model)$coefficients
  
  # Find Water_Q variables
  water_vars <- rownames(coef_table)[grep("Water_Q", rownames(coef_table))]
  
  # Get trend p-value
  trend_p <- summary(trend_model)$coefficients["Water_Q_numeric", "Pr(>|z|)"]
  
  # Initialize results dataframe
  result <- data.frame(
    Model = character(),
    Quartile = character(),
    OR = numeric(),
    Lower = numeric(),
    Upper = numeric(),
    P = numeric(),
    P_trend = character(),
    stringsAsFactors = FALSE
  )
  
  # Add Q1 reference
  result <- rbind(result, data.frame(
    Model = model_name,
    Quartile = "Q1 (Ref)",
    OR = 1,
    Lower = NA,
    Upper = NA,
    P = NA,
    P_trend = format(trend_p, digits = 4),
    stringsAsFactors = FALSE
  ))
  
  # Add other quartiles
  for(var in water_vars) {
    q_name <- gsub("Water_Q", "", var)
    beta <- coef_table[var, "Estimate"]
    se <- coef_table[var, "Std. Error"]
    p <- coef_table[var, "Pr(>|z|)"]
    
    result <- rbind(result, data.frame(
      Model = "",
      Quartile = q_name,
      OR = exp(beta),
      Lower = exp(beta - 1.96 * se),
      Upper = exp(beta + 1.96 * se),
      P = p,
      P_trend = "",
      stringsAsFactors = FALSE
    ))
  }
  
  return(result)
}

#results for all models
or_m1 <- extract_OR(m1, "Unadjusted", m1_trend)
or_m2 <- extract_OR(m2, "Adjusted: Demographics", m2_trend)
or_m3 <- extract_OR(m3, "Fully Adjusted", m3_trend)

or_results <- rbind(or_m1, or_m2, or_m3)

#Display table
or_results %>%
  mutate(
    `OR (95% CI)` = ifelse(is.na(Lower), 
                           "1.00 (Ref)", 
                           sprintf("%.3f (%.3f-%.3f)", OR, Lower, Upper)),
    P = ifelse(is.na(P), "-", 
              ifelse(P < 0.001, "<0.001", sprintf("%.3f", P))),
    P_trend = ifelse(P_trend == "", "", 
                    ifelse(as.numeric(P_trend) < 0.001, "<0.001", 
                          sprintf("%.3f", as.numeric(P_trend))))
  ) %>%
  select(Model, Quartile, `OR (95% CI)`, P, P_trend) %>%
  kable(caption = "Odds Ratios for Diabetes by Water Intake Quartiles") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  footnote(general = "P_trend: P-value for linear trend across quartiles")

write.csv(or_results, "Logistic_Results.csv", row.names = FALSE)

summary(m3)
```


# Linear Regression: HbA1c by Water Quartiles
```{r linear}
#3 models with water quartiles
lm1 <- lm(HbA1c ~ Water_Q, data = df)

lm2 <- lm(HbA1c ~ Water_Q + Age + Gender + Race + Education + Income_PIR, 
          data = df)

lm3 <- lm(HbA1c ~ Water_Q + Age + Gender + Race + Education + Income_PIR + 
            BMI + Smoking + Energy_kcal + Sugar_g, 
          data = df)

# Trend test
lm1_trend <- lm(HbA1c ~ Water_Q_numeric, data = df)

lm2_trend <- lm(HbA1c ~ Water_Q_numeric + Age + Gender + Race + Education + Income_PIR, 
                data = df)

lm3_trend <- lm(HbA1c ~ Water_Q_numeric + Age + Gender + Race + Education + Income_PIR + 
                  BMI + Smoking + Energy_kcal + Sugar_g, 
                data = df)

#Extract Beta
extract_Beta <- function(model, model_name, trend_model) {
  
coef_table <- summary(model)$coefficients
  
#Water_Q variables
water_vars <- rownames(coef_table)[grep("Water_Q", rownames(coef_table))]
  
#trend p-value
trend_p <- summary(trend_model)$coefficients["Water_Q_numeric", "Pr(>|t|)"]
  
#results dataframe
  result <- data.frame(
    Model = character(),
    Quartile = character(),
    Beta = numeric(),
    Lower = numeric(),
    Upper = numeric(),
    P = numeric(),
    P_trend = character(),
    stringsAsFactors = FALSE
  )
  
  #Add Q1 reference
  result <- rbind(result, data.frame(
    Model = model_name,
    Quartile = "Q1 (Ref)",
    Beta = 0,
    Lower = NA,
    Upper = NA,
    P = NA,
    P_trend = format(trend_p, digits = 4),
    stringsAsFactors = FALSE
  ))
  
  # Add other quartiles
  for(var in water_vars) {
    q_name <- gsub("Water_Q", "", var)
    beta <- coef_table[var, "Estimate"]
    se <- coef_table[var, "Std. Error"]
    p <- coef_table[var, "Pr(>|t|)"]
    
    result <- rbind(result, data.frame(
      Model = "",
      Quartile = q_name,
      Beta = beta,
      Lower = beta - 1.96 * se,
      Upper = beta + 1.96 * se,
      P = p,
      P_trend = "",
      stringsAsFactors = FALSE
    ))
  }
  
  return(result)
}

# Get results for all models
beta_m1 <- extract_Beta(lm1, "Unadjusted", lm1_trend)
beta_m2 <- extract_Beta(lm2, "Adjusted: Demographics", lm2_trend)
beta_m3 <- extract_Beta(lm3, "Fully Adjusted", lm3_trend)

# Combine
beta_results <- rbind(beta_m1, beta_m2, beta_m3)

# Display table
beta_results %>%
  mutate(
    `Beta (95% CI)` = ifelse(is.na(Lower), 
                             "0.00 (Ref)", 
                             sprintf("%.4f (%.4f to %.4f)", Beta, Lower, Upper)),
    P = ifelse(is.na(P), "-", 
              ifelse(P < 0.001, "<0.001", sprintf("%.3f", P))),
    P_trend = ifelse(P_trend == "", "", 
                    ifelse(as.numeric(P_trend) < 0.001, "<0.001", 
                          sprintf("%.3f", as.numeric(P_trend))))
  ) %>%
  select(Model, Quartile, `Beta (95% CI)`, P, P_trend) %>%
  kable(caption = "Beta Coefficients for HbA1c by Water Intake Quartiles") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  footnote(general = "P_trend: P-value for linear trend across quartiles")

write.csv(beta_results, "Linear_Results.csv", row.names = FALSE)

cat("\n=== Fully Adjusted Model Summary ===\n")
summary(lm3)
```


# Sensitivity Analysis: Continuous Water Variable
```{r sensitivity}
#Logistic regression
m_cont <- glm(Diabetes ~ Water_g + Age + Gender + Race + Education + Income_PIR + 
                BMI + Smoking + Energy_kcal + Sugar_g, 
              data = df, family = binomial)

#Linear regression
lm_cont <- lm(HbA1c ~ Water_g + Age + Gender + Race + Education + Income_PIR + 
                BMI + Smoking + Energy_kcal + Sugar_g, 
              data = df)

#Extract results (per 100g increase)
coef_log <- summary(m_cont)$coefficients["Water_g", ]
coef_lm <- summary(lm_cont)$coefficients["Water_g", ]

sens_results <- data.frame(
  Outcome = c("Diabetes (OR per 100g)", "HbA1c (Beta per 100g)"),
  Estimate = c(exp(coef_log[1] * 100), coef_lm[1] * 100),
  Lower = c(exp((coef_log[1] - 1.96*coef_log[2]) * 100),
            (coef_lm[1] - 1.96*coef_lm[2]) * 100),
  Upper = c(exp((coef_log[1] + 1.96*coef_log[2]) * 100),
            (coef_lm[1] + 1.96*coef_lm[2]) * 100),
  P = c(coef_log[4], coef_lm[4])
)

sens_results %>%
  mutate(
    `Estimate (95% CI)` = sprintf("%.4f (%.4f-%.4f)", Estimate, Lower, Upper),
    P = ifelse(P < 0.001, "<0.001", sprintf("%.3f", P))
  ) %>%
  select(Outcome, `Estimate (95% CI)`, P) %>%
  kable(caption = "Sensitivity Analysis: Water as Continuous Variable") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

write.csv(sens_results, "Sensitivity_Analysis.csv", row.names = FALSE)
```


# Summary
```{r summary}
# Sample size
cat(sprintf("N = %d\n\n", nrow(df)))

# Diabetes prevalence
cat(sprintf("Diabetes prevalence = %.1f%%\n\n", 100*mean(df$Diabetes == "Yes")))

# Water intake by quartiles
cat("Water intake (g) by quartiles:\n")
for(q in levels(df$Water_Q)) {
  x <- df$Water_g[df$Water_Q == q]
  cat(sprintf("  %s: Median = %.0f [IQR: %.0f-%.0f]\n", 
              q, median(x), quantile(x, 0.25), quantile(x, 0.75)))
}
cat("\n")

# Diabetes prevalence by quartiles
cat("Diabetes prevalence by quartiles:\n")
for(q in levels(df$Water_Q)) {
  prev <- mean(df$Diabetes[df$Water_Q == q] == "Yes") * 100
  cat(sprintf("  %s: %.1f%%\n", q, prev))
}
cat("\n")

# Main results: Q4 vs Q1 (Fully Adjusted)
q4_or <- or_results %>% filter(Model == "Fully Adjusted", Quartile == "Q4")
cat(sprintf("Q4 vs Q1 OR = %.3f (95%% CI: %.3f-%.3f), P = %.3f\n",
           q4_or$OR, q4_or$Lower, q4_or$Upper, q4_or$P))

q4_beta <- beta_results %>% filter(Model == "Fully Adjusted", Quartile == "Q4")
cat(sprintf("Q4 vs Q1 Beta = %.4f (95%% CI: %.4f to %.4f), P = %.3f\n\n",
           q4_beta$Beta, q4_beta$Lower, q4_beta$Upper, q4_beta$P))

# Trend tests
cat(sprintf("P for trend (Diabetes) = %.4f\n",
           summary(m3_trend)$coefficients["Water_Q_numeric", "Pr(>|z|)"]))
cat(sprintf("P for trend (HbA1c) = %.4f\n",
           summary(lm3_trend)$coefficients["Water_Q_numeric", "Pr(>|t|)"]))
```


# Visualization
```{r viz_setup}
# Create figures folder
dir.create("figures", showWarnings = FALSE)
```

# Figure 1: Water intake distribution by diabetes status
```{r fig1, fig.width=8, fig.height=6}
p1 <- ggplot(df, aes(x = Water_g, fill = Diabetes)) +
  geom_density(alpha = 0.4) +
  scale_fill_manual(values = c("No" = "#2c7bb6", "Yes" = "pink")) +
  labs(title = "Water Intake Distribution by Diabetes Status",
       x = "Water Intake (g)", y = "Density", fill = "Diabetes") +
  theme_minimal() +
  theme(legend.position = "top")
print(p1)
ggsave("figures/fig1_water_distribution.png", p1, width = 8, height = 6, dpi = 300)
```

# Figure 2: BMI distribution by water quartiles
```{r fig2, fig.width=8, fig.height=6}
p2 <- ggplot(df, aes(x = Water_Q, y = BMI, fill = Water_Q)) +
  geom_violin(alpha = 0.7) +
  geom_boxplot(width = 0.2, fill = "white", outlier.alpha = 0.3) +
  stat_compare_means(method = "anova") +
  scale_fill_manual(values = c("#d7191c", "#fdae61", "#abd9e9", "#2c7bb6")) +
  labs(title = "BMI Distribution by Water Intake Quartiles",
       x = "Water Intake Quartile", y = "BMI (kg/m2)") +
  theme_minimal() +
  theme(legend.position = "none")
print(p2)
ggsave("figures/fig2_bmi_quartiles.png", p2, width = 8, height = 6, dpi = 300)
```

# Figure 3: Water intake vs HbA1c by diabetes status
```{r fig3, fig.width=8, fig.height=6}
p3 <- ggplot(df, aes(x = Water_g, y = HbA1c, color = Diabetes, fill = Diabetes)) +
  geom_point(alpha = 0.3, size = 1.5) +
  geom_smooth(method = "loess", alpha = 0.2) +
  scale_color_manual(values = c("No" = "#2c7bb6", "Yes" = "#d7191c")) +
  scale_fill_manual(values = c("No" = "#2c7bb6", "Yes" = "#d7191c")) +
  labs(title = "Water Intake vs HbA1c by Diabetes Status",
       x = "Water Intake (g)", y = "HbA1c (%)", 
       color = "Diabetes", fill = "Diabetes") +
  theme_minimal() +
  theme(legend.position = "top")
print(p3)
ggsave("figures/fig3_water_hba1c.png", p3, width = 8, height = 6, dpi = 300)
```


# Figure 4: Forest plot - OR by quartiles (FIXED)
```{r fig4, fig.width=8, fig.height=5}
# Only keep rows where Quartile is Q2, Q3, Q4 AND belongs to Fully Adjusted model
or_plot <- or_results %>%
  mutate(row_id = row_number()) %>%
  filter(Quartile %in% c("Q2", "Q3", "Q4")) %>%
  # Find which rows belong to Fully Adjusted section
  mutate(in_fully_adjusted = FALSE)

# Manually identify Fully Adjusted section
fully_adj_start <- which(or_results$Model == "Fully Adjusted")
if(length(fully_adj_start) > 0) {
  # Get all rows from Fully Adjusted start until next model or end
  next_model <- which(or_results$Model != "" & or_results$Model != "Fully Adjusted")
  next_model <- next_model[next_model > fully_adj_start]
  
  if(length(next_model) > 0) {
    fully_adj_end <- next_model[1] - 1
  } else {
    fully_adj_end <- nrow(or_results)
  }
  
  or_plot <- or_results %>%
    slice(fully_adj_start:fully_adj_end) %>%
    filter(Quartile != "Q1 (Ref)")
}

# Create plot
p4 <- ggplot(or_plot, aes(x = OR, y = factor(Quartile, levels = c("Q4", "Q3", "Q2")))) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "gray40") +
  geom_point(size = 4, color = "#d7191c") +
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), 
                 height = 0.2, color = "#d7191c", linewidth = 1) +
  labs(title = "Odds Ratio for Diabetes by Water Quartiles (Fully Adjusted)",
       x = "Odds Ratio (95% CI)", y = "Water Intake Quartile") +
  theme_minimal() +
  theme(axis.text = element_text(size = 11))
print(p4)
ggsave("figures/fig4_odds_ratio.png", p4, width = 8, height = 5, dpi = 300)
```

# Figure 5: Forest plot - Beta by quartiles (FIXED)
```{r fig5, fig.width=8, fig.height=5}
# Same logic for beta
fully_adj_start <- which(beta_results$Model == "Fully Adjusted")
if(length(fully_adj_start) > 0) {
  next_model <- which(beta_results$Model != "" & beta_results$Model != "Fully Adjusted")
  next_model <- next_model[next_model > fully_adj_start]
  
  if(length(next_model) > 0) {
    fully_adj_end <- next_model[1] - 1
  } else {
    fully_adj_end <- nrow(beta_results)
  }
  
  beta_plot <- beta_results %>%
    slice(fully_adj_start:fully_adj_end) %>%
    filter(Quartile != "Q1 (Ref)")
}

# Create plot
p5 <- ggplot(beta_plot, aes(x = Beta, y = factor(Quartile, levels = c("Q4", "Q3", "Q2")))) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  geom_point(size = 4, color = "#2c7bb6") +
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), 
                 height = 0.2, color = "#2c7bb6", linewidth = 1) +
  labs(title = "Beta Coefficient for HbA1c by Water Quartiles (Fully Adjusted)",
       x = "Beta Coefficient (95% CI)", y = "Water Intake Quartile") +
  theme_minimal() +
  theme(axis.text = element_text(size = 11))
print(p5)
ggsave("figures/fig5_beta_coefficient.png", p5, width = 8, height = 5, dpi = 300)
```





# Figure 7: Mean HbA1c by quartiles
```{r fig7, fig.width=8, fig.height=6}
# Prepare data
trend_hba1c <- df %>%
  group_by(Water_Q) %>%
  summarise(
    mean = mean(HbA1c, na.rm = TRUE),
    sd = sd(HbA1c, na.rm = TRUE),
    n = n(),
    .groups = 'drop'
  ) %>%
  mutate(se = sd / sqrt(n))

# Create plot
p7 <- ggplot(trend_hba1c, aes(x = Water_Q, y = mean, group = 1)) +
  geom_col(aes(fill = Water_Q), alpha = 0.7, width = 0.6) +
  geom_errorbar(aes(ymin = mean - 1.96*se, ymax = mean + 1.96*se), 
                width = 0.2, color = "gray20") +
  geom_line(color = "#2c7bb6", linewidth = 1.2) +
  geom_point(color = "#2c7bb6", size = 3) +
  scale_fill_manual(values = c("#d7191c", "#fdae61", "#abd9e9", "#2c7bb6")) +
  labs(title = "Mean HbA1c by Water Intake Quartiles",
       x = "Water Intake Quartile", y = "Mean HbA1c (%)") +
  theme_minimal() +
  theme(legend.position = "none")
print(p7)
ggsave("figures/fig7_hba1c_mean.png", p7, width = 8, height = 6, dpi = 300)
```

# Figure 8: Correlation heatmap
```{r fig8, fig.width=8, fig.height=8}
# Prepare data
cor_data <- df %>%
  select(Water_g, Age, BMI, Energy_kcal, Sugar_g, HbA1c) %>%
  drop_na()

# Create and save plot
png("figures/fig8_correlation.png", width = 2400, height = 2400, res = 300)
corrplot(cor(cor_data), 
         method = "color", 
         type = "upper",
         addCoef.col = "black", 
         number.cex = 0.8,
         tl.col = "black", 
         tl.srt = 45,
         col = colorRampPalette(c("#2c7bb6", "white", "pink"))(200))
dev.off()

# Display in notebook
corrplot(cor(cor_data), 
         method = "color", 
         type = "upper",
         addCoef.col = "black", 
         number.cex = 0.8,
         tl.col = "black", 
         tl.srt = 45,
         col = colorRampPalette(c("#2c7bb6", "white", "pink"))(200))
```

# Figure 9: Stratified by BMI
```{r fig9, fig.width=12, fig.height=5}
# Prepare data
df_plot <- df %>%
  mutate(BMI_cat = cut(BMI, 
                       breaks = c(0, 25, 30, Inf),
                       labels = c("Normal (<25)", "Overweight (25-30)", "Obese (â‰¥30)"))) %>%
  filter(!is.na(BMI_cat))

# Create plot
p9 <- ggplot(df_plot, aes(x = Water_Q, y = HbA1c, fill = Water_Q)) +
  geom_boxplot(outlier.alpha = 0.3) +
  facet_wrap(~BMI_cat, nrow = 1) +
  stat_compare_means(method = "anova") +
  scale_fill_manual(values = c("#d7191c", "#fdae61", "#abd9e9", "#2c7bb6")) +
  labs(title = "Water Intake and HbA1c Stratified by BMI",
       x = "Water Intake Quartile", y = "HbA1c (%)") +
  theme_minimal() +
  theme(legend.position = "none")
print(p9)
ggsave("figures/fig9_stratified_bmi.png", p9, width = 12, height = 5, dpi = 300)
```



